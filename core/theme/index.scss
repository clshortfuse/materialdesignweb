@import './exports.scss';
@import './palettes.scss';
@import './globals.scss';

$mdw-theme__tone-list: ("50", "100", "200", "300", "400", "500", "600", "700", "800", "900", "A100", "A200", "A400", "A700") !default;

@mixin mdw-theme__configure($config-map: ()) {
  $themes: (
    "default": ('indigo', 'pink', 'red', 'grey', black, white),
  );
  $colors: ();
  $fallbacks: ('rules', 'colors', 'themes', 'ieonly');
  $variables: ('rules', 'colors', 'themes', 'supports');

  @if (map-has-key($config-map, $key: "themes")) {
    $themes: map-get($config-map, "themes");
  }
  @if (map-has-key($map: $config-map, $key: "colors")) {
    $colors: map-get($config-map, "colors");
  }
  @if (map-has-key($map: $config-map, $key: "fallbacks")) {
    $fallbacks: map-get($config-map, "fallbacks");
  }
  @if (map-has-key($map: $config-map, $key: "variables")) {
    $variables: map-get($config-map, "variables");
  }

  @each $theme in map-values($themes) {
    $palettes: ('indigo', 'pink', 'red', 'grey');
    @for $i from 1 to 5 {
      @if (length($theme) >= $i) {
        $palettes: set-nth($palettes, $i, nth($theme, $i));
      }
    }
    @each $palette in $palettes {
      @if (index($colors, $palette) == null) {
        $colors: append($colors, $palette);
      }
    }
  }

  $mdw-theme__themes: $themes !global;
  $mdw-theme__colors: $colors !global;
  $mdw-theme__fallbacks: $fallbacks !global;
  $mdw-theme__variables: $variables !global;
}

@mixin mdw-theme__build($config-map: null) {
  @if ($config-map != null) {
    @include mdw-theme__configure($config-map);
  }

  @if ($mdw-theme__fallbacks and $mdw-theme__fallbacks != 'no' and $mdw-theme__fallbacks != false) {
    @if (index($mdw-theme__fallbacks, 'ieonly')) {
      @include mdw-platform__ie() {
        @include __mdw-theme__build-fallbacks();
      }
    } @else {
      @include __mdw-theme__build-fallbacks();
    }
  }

  @if ($mdw-theme__variables and $mdw-theme__variables != 'no' and $mdw-theme__variables != false) {
    @if (index($mdw-theme__variables, 'supports')) {
      @supports(--v:v) {
        @include __mdw-theme__build-variables();
      }
    } @else {
      @include __mdw-theme__build-variables();
    }
  }
}

@mixin __mdw-theme__build-variables() {
  @if (index($mdw-theme__variables, 'rules')) {
    @include __mdw-theme__build-rules();
  }
  @if (index($mdw-theme__variables, 'colors')) {
    @include __mdw-theme__build-colors();
  }
  @if (index($mdw-theme__variables, 'themes')) {
    @include __mdw-theme__build-themes();
  }
}

@mixin __mdw-theme__add-component-variables($lightness: null) {
  @if ($lightness == 'light') {
    --foreground-color: var(--foreground-light-color);
  } @else if($lightness == 'dark') {
    --foreground-color: var(--foreground-dark-color);
  }

  @include mdw-theme__global-theme-variables($lightness);
}


@mixin __mdw-theme__add-contrast-and-theme-rules($type: 'var', $theme: null) {
  @include mdw-theme__global-contrast-and-theme-rules($type, $theme);
}

@mixin __mdw-theme__build-fallbacks() {
  // Fill rules
  // Component rules
  // Color rules
  @if (map-has-key($mdw-theme__themes, "default")) {
    .mdw-theme[mdw-fill="white"] {
      background-color: #fff;
    }

    .mdw-theme[mdw-fill="black"] {
      background-color: #000;
    }
  }
  @each $name in map-keys($mdw-theme__themes) {
    $theme: map-get($mdw-theme__themes, $name);
    $namespace: if($name == 'default', null, '.mdw-theme[mdw-theme="#{$name}"]');
    @each $param in ('primary', 'accent', 'warn', 'background') {
      $palette: mdwGetThemeParamValue($param, $theme);
      @each $tone in $mdw-theme__tone-list {
        $value: map-get($palette, $tone);
        $rgbValue: red($value), green($value), blue($value);
        @if ($tone == '500') {
          @if ($param != 'background') {
            #{$namespace} .mdw-theme[mdw-fill="#{$param}"] {
              background-color: #{$value};
            }
          }
        }

        #{$namespace} .mdw-theme[mdw-fill="#{$param} #{$tone}"] {
          background-color: #{$value};
        }
      }
    }
  }

  @each $color in $mdw-theme__colors {
    $palette: map-get($mdw-theme__palettes, $color);
    @each $tone in $mdw-theme__tone-list {
      $value: map-get($palette, $tone);
      @if ($tone == '500') {
        .mdw-theme[mdw-fill="#{$color}"] {
          background-color: #{$value};
        }
      }

      .mdw-theme[mdw-fill="#{$color} #{$tone}"] {
        background-color: #{$value};
      }
    }
  }


  @each $name in map-keys($mdw-theme__themes) {
    $theme: map-get($mdw-theme__themes, $name);
    $namespace: '.mdw-theme[mdw-theme="#{$name}"]';

    #{$namespace}[mdw-light][mdw-fill],
    #{$namespace} .mdw-theme[mdw-light][mdw-fill] {
      color: mdwThemeGlobalValue("text-color", 'light', $theme);
    }


    #{$namespace}[mdw-dark][mdw-fill],
    #{$namespace} .mdw-theme[mdw-dark][mdw-fill] {
      color: mdwThemeGlobalValue("text-color", 'dark', $theme);
    }
    
    #{$namespace}[mdw-light],
    #{$namespace}[mdw-dark] .mdw-theme[mdw-light],
    #{$namespace} .mdw-theme[mdw-light],
    #{$namespace} .mdw-theme[mdw-dark] .mdw-theme[mdw-light] {
      @include __mdw-theme__add-contrast-and-theme-rules('light', $theme);
    }

    #{$namespace}[mdw-dark],
    #{$namespace}[mdw-light] .mdw-theme[mdw-dark],
    #{$namespace} .mdw-theme[mdw-dark],
    #{$namespace} .mdw-theme[mdw-light] .mdw-theme[mdw-dark] {
      @include __mdw-theme__add-contrast-and-theme-rules('dark', $theme);
    }
  }

  @if (map-has-key($mdw-theme__themes, "default")) {
    .mdw-theme[mdw-color="white"] {
      color: #fff;
    }

    .mdw-theme[mdw-color="black"] {
      color: #000;
    }
  }

  @each $name in map-keys($mdw-theme__themes) {
    $theme: map-get($mdw-theme__themes, $name);
    $namespace: '.mdw-theme[mdw-theme="#{$name}"]';
    @each $param in ('primary', 'accent', 'warn', 'background') {
      $palette: mdwGetThemeParamValue($param, $theme);
      @each $tone in $mdw-theme__tone-list {
        $value: map-get($palette, $tone);
        $rgbValue: red($value), green($value), blue($value);
        @if ($tone == '500') {
          #{$namespace}[mdw-color="#{$param}"],
          #{$namespace} .mdw-theme[mdw-color="#{$param}"] {
            color: #{$value};
          }
        }

        #{$namespace}[mdw-color="#{$param} #{$tone}"],
        #{$namespace} .mdw-theme[mdw-color="#{$param} #{$tone}"] {
          color: #{$value};
        }
      }
    }
  }

  @each $color in $mdw-theme__colors {
    $palette: map-get($mdw-theme__palettes, $color);
    @each $tone in $mdw-theme__tone-list {
      $value: map-get($palette, $tone);
      @if ($tone == '500') {
        .mdw-theme[mdw-color="#{$color}"] {
          color: #{$value};
        }
      }

      .mdw-theme[mdw-color="#{$color} #{$tone}"] {
        color: #{$value};
      }
    }
  }
}

@mixin __mdw-theme__build-rules() {
  :root,
  .mdw-theme[mdw-theme],
  .mdw-theme[mdw-fill] {
    --color: var(--foreground-color);
  }

  .mdw-theme[mdw-fill] {
    --fill-color: var(--500-fill);
  }

  .mdw-theme[mdw-color] {
    --color: var(--500-color);
  }

  .mdw-theme[mdw-fill="white"] {
    --fill-color: 255,255,255;
  }

  .mdw-theme[mdw-color="white"] {
    --color: 255,255,255;
  }

  .mdw-theme[mdw-fill="black"] {
    --fill-color: 0,0,0;
  }

  .mdw-theme[mdw-color="black"] {
    --color: 0,0,0;
  }

  @each $color in ('primary', 'accent', 'warn', 'background') {
    @each $tone in $mdw-theme__tone-list {
      .mdw-theme[mdw-fill~="#{$color}"] {
        @each $tone in $mdw-theme__tone-list {
          --#{$tone}-fill: var(--#{$color}-#{$tone}-color);
        }
      }

      .mdw-theme[mdw-color~="#{$color}"] {
        @each $tone in $mdw-theme__tone-list {
          --#{$tone}-color: var(--#{$color}-#{$tone}-color);
        }
      }
    }
  }

  @each $tone in $mdw-theme__tone-list {
    .mdw-theme[mdw-fill~="#{$tone}"] {
      --fill-color: var(--#{$tone}-fill);
    }

    .mdw-theme[mdw-color~="#{$tone}"] {
      --color: var(--#{$tone}-color);
    }
  }

  /* stylelint-disable-next-line no-duplicate-selectors */
  .mdw-theme[mdw-fill] {
    background-color: unquote("rgb(var(--fill-color))");
  }

  /* stylelint-disable-next-line no-duplicate-selectors */
  .mdw-theme[mdw-color] {
    color: unquote("rgb(var(--color))");
  }

  :root,
  .mdw-theme[mdw-light] {
    @include __mdw-theme__add-component-variables('light');
  }

  .mdw-theme[mdw-dark] {
    @include __mdw-theme__add-component-variables('dark');
  }

  /* stylelint-disable-next-line order/order */
  @include __mdw-theme__add-contrast-and-theme-rules();
}

@mixin __mdw-theme__build-colors() {
  @each $color in $mdw-theme__colors {
    $palette: map-get($mdw-theme__palettes, $color);
    @each $tone in map-keys(map-remove($palette, "light", "dark")) {
      $value: map-get($palette, $tone);

      :root {
        --#{$color}-#{$tone}-color: #{red($value),green($value),blue($value)};
        @if ($tone == "500") {
          --#{$color}-color: #{red($value),green($value),blue($value)};
        } 
      }
    }
  }
  @each $color in $mdw-theme__colors {
    .mdw-theme[mdw-fill~="#{$color}"] {
      @each $tone in $mdw-theme__tone-list {
        --#{$tone}-fill: var(--#{$color}-#{$tone}-color);
      }
    }

    .mdw-theme[mdw-color~="#{$color}"] {
      @each $tone in $mdw-theme__tone-list {
        --#{$tone}-color: var(--#{$color}-#{$tone}-color);
      }
    }
  }
}

@mixin __mdw-theme__build-themes() {
  @each $name in map-keys($mdw-theme__themes) {
    $theme: map-get($mdw-theme__themes, $name);
    $namespace: if($name == 'default', null, '.mdw-theme[mdw-theme="#{$name}"]');
    $params: ('indigo', 'pink', 'red', 'grey', black, white);
    @for $i from 1 to 7 {
      @if (length($theme) >= $i) {
        $params: set-nth($params, $i, nth($theme, $i));
      }
    }
    $primary: nth($params, 1);
    $accent: nth($params, 2);
    $warn: nth($params, 3);
    $background: nth($params, 4);
    $foreground-light: nth($params, 5);
    $foreground-dark: nth($params, 6);
    @include mdw-theme__build-palettes($namespace, $primary, $accent, $warn, $background);

    #{if($namespace, #{$namespace}, ':root, .mdw-theme[mdw-theme="default"]')} {
      --foreground-light-color: #{red($foreground-light),green($foreground-light),blue($foreground-light)};
      --foreground-dark-color: #{red($foreground-dark),green($foreground-dark),blue($foreground-dark)};
    }
  }
}

@mixin mdw-theme__build-palettes($namespace, $primary, $accent, $warn, $background) {
  @include mdw-theme__build-palette($namespace, 'primary', $primary);
  @include mdw-theme__build-palette($namespace, 'accent', $accent);
  @include mdw-theme__build-palette($namespace, 'warn', $warn);
  @include mdw-theme__build-palette($namespace, 'background', $background);
}

@mixin mdw-theme__build-palette($namespace, $color, $name) {
  $palette: map-get($mdw-theme__palettes, $name);
  @each $tone in map-keys(map-remove($palette, "light", "dark")) {
    $value: map-get($palette, $tone);

    #{if($namespace, #{$namespace}, ':root, .mdw-theme[mdw-theme="default"]')} {
      --#{$color}-#{$tone}-color: var(--#{$name}-#{$tone}-color);
      @if ($tone == "500" and $color != 'background') {
        --#{$color}-color: var(--#{$name}-color);
      }
    }
  }
}
