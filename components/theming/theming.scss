@import 'palettes.scss';
@import '../common/functions.scss';


@import './globals.scss';

@import '../bottomnav/theming.scss';
@import '../button/theming.scss';
@import '../card/theming.scss';
@import '../chip/theming.scss';
@import '../datatable/theming.scss';
@import '../dialog/theming.scss';
@import '../divider/theming.scss';
@import '../list/theming.scss';
@import '../menu/theming.scss';
@import '../navdrawer/theming.scss';
@import '../selection/theming.scss';
@import '../tab/theming.scss';
@import '../textfield/theming.scss';
@import '../type/theming.scss';

$tone-list: ("50", "100", "200", "300", "400", "500", "600", "700", "800", "900", "A100", "A200", "A400", "A700");
$added-palettes-list: ();


@mixin buildMDWThemes($config-map: ()) {
  $theme-components: (
    'bottomnav',
    'button',
    'card',
    'chip',
    'datatable',
    'dialog',
    'divider',
    'list',
    'menu',
    'navdrawer',
    'selection',
    'tab',
    'textfield',
  );
  $themes: (
    "default": ('indigo', 'pink', 'red', 'grey', black, white),
  );
  $explicit-colors: ();
  $automatic-contrast: 'no';
  $ie11-support: 'only';
  $ie11-media-wrap: 'no';
  @if (map-has-key($config-map, $key: "theme-components")) {
    $theme-components: map-get($config-map, "theme-components");
  }
  @if (map-has-key($config-map, $key: "themes")) {
    $themes: map-get($config-map, "themes");
  }
  @if (map-has-key($map: $config-map, $key: "explicit-colors")) {
    $explicit-colors: map-get($config-map, "explicit-colors");
  }
  @if (map-has-key($map: $config-map, $key: "automatic-contrast")) {
    $automatic-contrast: map-get($config-map, "automatic-contrast");
  }
  @if (map-has-key($map: $config-map, $key: "ie11-support")) {
    $ie11-support: map-get($config-map, "ie11-support");
  }
  @if (map-has-key($map: $config-map, $key: "ie11-media-wrap")) {
    $ie11-media-wrap: map-get($config-map, "ie11-media-wrap");
  }
  $mdw-theme__components: $theme-components !global;
  $mdw-theme__explicit-colors: $explicit-colors !global;
  $mdw-theme__automatic-contrast: $automatic-contrast !global;
  $mdw-theme__ie11-support: $ie11-support !global;
  $mdw-theme__themes: $themes !global;
  $mdw-theme__ie11-media-wrap: $ie11-media-wrap !global;
  @include buildThemes();
}

@mixin addVariables($lightness, $color:"background") {
  @if ($lightness == 'light') {
    --color: var(--foreground-light-color);
  } @else {
    --color: var(--foreground-dark-color);
  }

  @include globalThemeVariables($color, $lightness);

  @if (index($mdw-theme__components, 'bottomnav')) {
    @include bottomnavThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'button')) {
    @include buttonThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'card')) {
    @include cardThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'chip')) {
    @include chipThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'datatable')) {
    @include datatableThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'dialog')) {
    @include dialogThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'divider')) {
    @include dividerThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'list')) {
    @include listThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'menu')) {
    @include menuThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'navdrawer')) {
    @include navdrawerThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'selection')) {
    @include selectionThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'tab')) {
    @include tabThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'textfield')) {
    @include textfieldThemeVariables($color, $lightness);
  }
  @if (index($mdw-theme__components, 'type')) {
    @include typeThemeVariables($color, $lightness);
  }
}


@mixin componentContrastAndThemeRules($type: 'var', $theme: null) {
  @include globalContrastAndThemeRules($type, $theme);

  @if (index($mdw-theme__components, 'button')) {
    @include buttonContrastAndThemeRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'datatable')) {
    @include datatableContrastAndThemeRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'list')) {
    @include listContrastAndThemeRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'selection')) {
    @include selectionContrastAndThemeRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'textfield')) {
    @include textfieldContrastAndThemeRules($type, $theme);
  }
}

@mixin componentContrastRules($type: 'var', $theme: null) {
  @if (index($mdw-theme__components, 'bottomnav')) {
    @include bottomnavContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'card')) {
    @include cardContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'chip')) {
    @include chipContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'datatable')) {
    @include datatableContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'dialog')) {
    @include dialogContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'divider')) {
    @include dividerContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'menu')) {
    @include menuContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'navdrawer')) {
    @include navdrawerContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'tab')) {
    @include tabContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'textfield')) {
    @include textfieldContrastRules($type, $theme);
  }
  @if (index($mdw-theme__components, 'type')) {
    @include typeContrastRules($type, $theme);
  }
}

@mixin componentThemeRules($theme: null) {
  @if (index($mdw-theme__components, 'bottomnav')) {
    @include bottomnavThemeRules($theme);
  }
}


@mixin buildThemes() {
  @if ($mdw-theme__ie11-support and $mdw-theme__ie11-support != 'no' and $mdw-theme__ie11-support != false) {
    @if ($mdw-theme__ie11-media-wrap and $mdw-theme__ie11-media-wrap != 'no' and $mdw-theme__ie11-media-wrap != false) {
      @include IEOnly() {
        @include buildFallbackThemes();
      }
    } @else {
      @include buildFallbackThemes();
    }
  }
  @if ($mdw-theme__ie11-support != 'only') {
    @include buildVariableThemes();
  }
}

@mixin buildFallbackThemes() {
  // Fill rules
  // Component rules
  // Color rules
  @if (map-has-key($mdw-theme__themes, "default")) {
    [mdw-theme-fill~="white"] {
      background-color: white;
    }
    [mdw-theme-fill~="black"] {
      background-color: black;
    }
  }
  @each $name in map-keys($mdw-theme__themes) {
    $theme: map-get($mdw-theme__themes, $name);
    $namespace: if($name == 'default', null, ".mdw-theme-#{$name}");
    @each $param in ('primary', 'accent', 'warn', 'background') {
      $palette: getThemeParamValue($param, $theme);
      @each $tone in $tone-list {
        $value: map-get($palette, $tone);
        $rgbValue: red($value), green($value), blue($value);
        @if ($tone == '500') {
          @if ($param != 'background') {
            #{$namespace} [mdw-theme-fill~="#{$param}"] {
              background-color: #{$value};
            }
          }
        }
        #{$namespace} [mdw-theme-fill~="#{$param}-#{$tone}"] {
          background-color: #{$value};
        }
      }
    }
  }

  @each $color in $mdw-theme__explicit-colors {
    $palette: map-get($palettes, $color);
    @each $tone in $tone-list {
      $value: map-get($palette, $tone);
      @if ($tone == '500') {
        [mdw-theme-fill~="#{$color}"] {
          background-color: #{$value};
        }
      }
      [mdw-theme-fill~="#{$color}-#{$tone}"] {
        background-color: #{$value};
      }
    }
  }

  @if (map-has-key($mdw-theme__themes, "default")) {
    [mdw-theme-fill~="light"] {
      @include componentContrastRules('light');
    }
    [mdw-theme-fill~="dark"] {
      @include componentContrastRules('dark');
    }
  }


  @each $name in map-keys($mdw-theme__themes) {
    $theme: map-get($mdw-theme__themes, $name);
    $namespace: if($name == 'default', null, ".mdw-theme-#{$name}");
    @if ($namespace) {
      #{$namespace} {
        @include componentThemeRules($theme);
      }
    } @else {
      @include componentThemeRules($theme);
    }
    #{$namespace} [mdw-theme-fill~="light"] {
      @include componentContrastAndThemeRules('light', $theme);
    }
    #{$namespace} [mdw-theme-fill~="dark"] {
      @include componentContrastAndThemeRules('dark', $theme);
    }
  }

  @if (map-has-key($mdw-theme__themes, "default")) {
    [mdw-theme-color~="white"] {
      color: white;
    }
    [mdw-theme-color~="black"] {
      color: black;
    }
  }

  @each $name in map-keys($mdw-theme__themes) {
    $theme: map-get($mdw-theme__themes, $name);
    $namespace: if($name == 'default', null, ".mdw-theme-#{$name}");
    @each $param in ('primary', 'accent', 'warn', 'background') {
      $palette: getThemeParamValue($param, $theme);
      @each $tone in $tone-list {
        $value: map-get($palette, $tone);
        $rgbValue: red($value), green($value), blue($value);
        @if ($tone == '500') {
          #{$namespace} [mdw-theme-color~="#{$param}"] {
            color: #{$value};
          }
        }
        #{$namespace} [mdw-theme-color~="#{$param}-#{$tone}"] {
          color: #{$value};
        }
      }
    }
  }

  @each $color in $mdw-theme__explicit-colors {
    $palette: map-get($palettes, $color);
    @each $tone in $tone-list {
      $value: map-get($palette, $tone);
      @if ($tone == '500') {
        [mdw-theme-color~="#{$color}"] {
          color: #{$value};
        }
      }
      [mdw-theme-color~="#{$color}-#{$tone}"] {
        color: #{$value};
      }
    }
  }
}

@mixin buildVariableThemes() {
  @each $color in $mdw-theme__explicit-colors {
    @include addSinglePaletteColorVariables($color);
  }
  @each $theme in map-values($mdw-theme__themes) {
    $palettes: ('indigo', 'pink', 'red', 'grey');
    @for $i from 1 to 5 {
      @if (length($theme) >= $i) {
        $palettes: set-nth($palettes, $i, nth($theme, $i));
      }
    }
    @each $palette in $palettes {
      @if (index($mdw-theme__explicit-colors, $palette) == null) {
        @include addSinglePaletteColorVariables($palette);
      }
    }
  }

  @each $name in map-keys($mdw-theme__themes) {
    // $name: map-get($theme, "name");
    $theme: map-get($mdw-theme__themes, $name);
    $namespace: if($name == 'default', null, ".mdw-theme-#{$name}");
    $params: ('indigo', 'pink', 'red', 'grey', black, white);
    @for $i from 1 to 7 {
      @if (length($theme) >= $i) {
        $params: set-nth($params, $i, nth($theme, $i));
      }
    }
    $primary: nth($params, 1);
    $accent: nth($params, 2);
    $warn: nth($params, 3);
    $background: nth($params, 4);
    $foreground-light: nth($params, 5);
    $foreground-dark: nth($params, 6);
    @include buildPalettes($namespace, $primary, $accent, $warn, $background);
    #{if($namespace, #{$namespace}, ":root, .mdw-theme-default")} {
      --foreground-light-color: #{red($foreground-light),green($foreground-light),blue($foreground-light)};
      --foreground-dark-color: #{red($foreground-dark),green($foreground-dark),blue($foreground-dark)};
    }
  }

  // Light rules
  [mdw-theme-fill~="white"],
  [mdw-theme-fill~="light"],
  :root {
    @include addVariables('light');
  }

  @if ($mdw-theme__automatic-contrast != 'no' and $mdw-theme__automatic-contrast != false) {
    @each $name in map-keys($mdw-theme__themes) {
      $theme: map-get($mdw-theme__themes, $name);
      $namespace: if($name == 'default', null, ".mdw-theme-#{$name}");
      @each $param in ('primary', 'accent', 'warn', 'background') {
        $palette: getThemeParamValue($param, $theme);
        $lightTones: map-get($palette, 'light');
        
        @each $tone in $lightTones {
          @if ($tone == '500' and $param != 'background') {
            #{$namespace} [mdw-theme-fill~="#{$param}"] {
              @include addVariables('light', $param);
            }
          }
          #{$namespace} [mdw-theme-fill~="#{$param}-#{$tone}"] {
            @include addVariables('light', $param);
          }
        }
        
      }
      @each $param in ('primary', 'accent', 'warn') {
        [mdw-theme-fill~="#{$param}"][mdw-theme-fill~="light"],
        [mdw-theme-fill|="#{$param}"][mdw-theme-fill~="light"] {
          @include addVariables('light', $param);
        }
      }
    }

    // Dark Variables
    @each $name in map-keys($mdw-theme__themes) {
      $theme: map-get($mdw-theme__themes, $name);
      $namespace: if($name == 'default', null, ".mdw-theme-#{$name}");
      @each $param in ('primary', 'accent', 'warn') {
        $palette: getThemeParamValue($param, $theme);
        $darkTones: map-get($palette, 'dark');
       
        @each $tone in $darkTones {
          $value: map-get($palette, $tone);
          @if ($tone == '500' and $param != 'background') {
            #{$namespace} [mdw-theme-fill~="#{$param}"] {
              @include addVariables('dark', $param);
            }
          }
          #{$namespace} [mdw-theme-fill~="#{$param}-#{$tone}"] {
            @include addVariables('dark', $param);
          }
        }
        
      }
      @each $param in ('primary', 'accent', 'warn') {
        [mdw-theme-fill~="#{$param}"][mdw-theme-fill~="dark"],
        [mdw-theme-fill|="#{$param}"][mdw-theme-fill~="dark"] {
          @include addVariables('dark', $param);
        }
      }
    }

    // Dark Background Variables
    @each $name in map-keys($mdw-theme__themes) {
      $theme: map-get($mdw-theme__themes, $name);
      $namespace: if($name == 'default', null, ".mdw-theme-#{$name}");
      $color: 'background';
      $palette: getThemeParamValue('background', $theme);
      $darkTones: map-get($palette, 'dark');
      @each $tone in $darkTones {
        $value: map-get($palette, $tone);
        @if ($tone == '500' and $color != 'background') {
          #{$namespace} [mdw-theme-fill~="#{$color}"] {
            @include addVariables('dark', $color);
          }
        }
        #{$namespace} [mdw-theme-fill~="#{$color}-#{$tone}"] {
          @include addVariables('dark', $color);
        }
      }
    }
  }


  [mdw-theme-fill~="black"],
  [mdw-theme-fill~="dark"] {
    @include addVariables('dark', 'background');
  }

  @include componentContrastAndThemeRules();
  @include componentContrastRules();
  @include componentThemeRules();

  [mdw-theme-fill~="white"] {
    --background-color: 255,255,255;
  }
  [mdw-theme-color~="white"] {
    --color: 255,255,255;
  }
  @each $color in ('primary', 'accent', 'warn', 'background') { 
    @each $tone in $tone-list {
      @if ($tone == '500') {
        @if ($color != 'background') {
          [mdw-theme-fill~="#{$color}"] {
            --background-color: var(--#{$color}-color);
          }
        }
        [mdw-theme-color~="#{$color}"] {
          --color: var(--#{$color}-color);
        }
      }
      [mdw-theme-fill~="#{$color}-#{$tone}"] {
        --background-color: var(--#{$color}-#{$tone}-color);
      }
      [mdw-theme-color~="#{$color}-#{$tone}"] {
        --color: var(--#{$color}-#{$tone}-color);
      }
    }
  }
  [mdw-theme-fill~="black"] {
    --background-color: 0,0,0;
  }
  [mdw-theme-color~="black"] {
    --color: 0,0,0;
  }
  @each $color in $mdw-theme__explicit-colors {
    @each $tone in $tone-list {
      @if ($tone == '500') {
        [mdw-theme-fill~="#{$color}"] {
          --background-color: var(--#{$color}-color);
        }
        [mdw-theme-color~="#{$color}"] {
          --color: var(--#{$color}-color);
        }
      }
      [mdw-theme-fill~="#{$color}-#{$tone}"] {
        --background-color: var(--#{$color}-#{$tone}-color);
      }
      [mdw-theme-color~="#{$color}-#{$tone}"] {
        --color: var(--#{$color}-#{$tone}-color);
      }
    }
  }

  [mdw-theme-fill] {
    background-color: unquote("rgb(var(--background-color))");
  }
  [mdw-theme-color] {
    color: unquote("rgb(var(--color))");
  }
}

@mixin addSinglePaletteColorVariables($name) {
  $palette: map-get($palettes, $name);
  @if (index($added-palettes-list, $name) == null) {
    @each $tone in map-keys(map-remove($palette, "light", "dark")) {
      $value: map-get($palette, $tone);
      :root {
        --#{$name}-#{$tone}-color: #{red($value),green($value),blue($value)};
        @if ($tone == "500") {
          --#{$name}-color: #{red($value),green($value),blue($value)};
        } 
      }
      $added-palettes-list: append($added-palettes-list, $name) !global;
    }
  }
}

@mixin buildPalettes($namespace, $primary, $accent, $warn, $background) {
  @include buildPalette($namespace, 'primary', $primary);
  @include buildPalette($namespace, 'accent', $accent);
  @include buildPalette($namespace, 'warn', $warn);
  @include buildPalette($namespace, 'background', $background);
}

@mixin buildPalette($namespace, $color, $name) {
  $palette: map-get($palettes, $name);
  @each $tone in map-keys(map-remove($palette, "light", "dark")) {
    $value: map-get($palette, $tone);
    #{if($namespace, #{$namespace}, ":root, .mdw-theme-default")} {
      --#{$color}-#{$tone}-color: var(--#{$name}-#{$tone}-color);
      @if ($tone == "500" and $color != 'background') {
        --#{$color}-color: var(--#{$name}-color);
      }
    }
  }
}
