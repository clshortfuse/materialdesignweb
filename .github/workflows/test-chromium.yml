name: Chromium
on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - 'demos/**'
      - '**.md'
      - '.github/workflows/publish.yml'
      - '.github/workflows/static.yml'
      # - '.github/workflows/test-chromium.yml'
      - '.github/workflows/test-firefox.yml'
      - '.github/workflows/test-webkit.yml'
      # - 'screenshots/reference/chromium/**'
      - 'screenshots/reference/firefox/**'
      - 'screenshots/reference/webkit/**'
  pull_request:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - 'demos/**'
      - '**.md'
      - '.github/workflows/publish.yml'
      - '.github/workflows/static.yml'
      # - '.github/workflows/test-chromium.yml'
      - '.github/workflows/test-firefox.yml'
      - '.github/workflows/test-webkit.yml'
      # - 'screenshots/reference/chromium/**'
      - 'screenshots/reference/firefox/**'
      - 'screenshots/reference/webkit/**'
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Detect package manager
        id: detect-package-manager
        run: |
          if [ -f "${{ github.workspace }}/package.json" ]; then
            echo "manager=npm" >> $GITHUB_OUTPUT
            echo "command=ci" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "Unable to determine packager manager"
            exit 1
          fi
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: ${{ steps.detect-package-manager.outputs.manager }}
      - uses: actions/cache@v3
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json') }}
      - name: Install dependencies
        run: ${{ steps.detect-package-manager.outputs.manager }} ${{ steps.detect-package-manager.outputs.command }}
      - run: npx playwright install --with-deps
        if: steps.playwright-cache.outputs.cache-hit != 'true'
      - run: npx playwright install-deps
        if: steps.playwright-cache.outputs.cache-hit == 'true'
      - name: Run Playwright tests
        id: run-tests
        run: |
          set -o pipefail
          npm run test:custom -- --playwright --browsers chromium 2>&1 | tee test-output.txt
          exit ${PIPESTATUS[0]}
      - name: Check for screenshot failures
        id: prepare-screenshots-failures
        if: failure()
        run: |
          echo "=== Starting screenshot failure extraction ==="
          
          # check for Screenshot too different.*with ([^:]+)
          # output each grep result to failed_screenshots.txt
          echo "Running grep to extract screenshot paths..."
          grep -oP 'Screenshot too different.*with \K([^:]*)' test-output.txt > failed_screenshots.txt || true
          
          echo "=== Content of failed_screenshots.txt ==="
          cat failed_screenshots.txt || echo "File is empty or missing"
          echo "=== End of file content ==="
          
          # Check if we have any failed screenshots
          if [ -s failed_screenshots.txt ]; then
            echo "Found failed screenshots, creating artifacts directory..."
            mkdir -p artifacts
            while IFS= read -r screenshot; do
              echo "Processing screenshot: $screenshot"
              if [ -f "$screenshot" ]; then
                echo "✓ File exists, copying to artifacts/"
                cp "$screenshot" artifacts/
              else
                echo "✗ File not found: $screenshot"
              fi
            done < failed_screenshots.txt
            echo "artifacts_path=artifacts" >> $GITHUB_OUTPUT
            echo "Set artifacts_path=artifacts"
          else
            echo "No failed screenshots found"
          fi
      - name: Upload filtered artifacts
        if: failure() && steps.prepare-screenshots-failures.outputs.artifacts_path != ''
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-failed-${{ github.run_id }}
          path: ${{ steps.prepare-screenshots-failures.outputs.artifacts_path }}
          retention-days: 7